商家安装支付应用流程​
本文档介绍商家如何发现、安装、授权和激活支付应用程序，以及支付应用方如何跟 SHOPLINE 平台打通流程。

商家激活使用支付应用​
发现​
如果该支付应用对当前店铺是可见的，那商家可以直接在 设置-收款-其他付款方式-选择其他付款方式 中发现该支付应用image.png

image.png

采取外跳模式的支付应用：用户在 设置-收款-其他付款方式-选择其他付款方式 中选择该支付应用 采取直连模式的支付应用：用户在 设置-收款-第三方支付方式 中选择该支付应用

安装&激活​
选择支付应用后，将进入支付应用安装页面，该页面会展示支付应用的基础信息及描述信息。

image.png

点击安装，此时用户会被重定向到支付应用授权页面：

image.png

授权完成之后，将重定向到你配置的应用回调地址，最终需要跳转到你维护的支付收款账号绑定页面；用户将在该页面完成 SHOPLINE 店铺与支付收款账号的绑定。

image.png

绑定完成后，您最终需要将用户重定向到回 SHOPLINE 商家后台，让用户可以完成后续的激活动作； 具体的页面链接格式为： https://{handle}.myshopline.com/admin/settings/payments/appInstall?appKey=xxxxx

注意：由于此时在 SHOPLINE 商家后台内嵌的授权页面进行重定向回SL Admin后台的操作，需要在该流程接入 App Bridge，否则将会出现页面嵌套的情况；

image.png

同时，支付应用需要调用 绑定成功通知 接口，告知 SHOPLINE 商户已经完成绑定；此时支付方式激活按钮才会变为可以点击；商家点击激活后，该支付方式会在结算页展示并可使用。

image.png

最终你的支付应用，将会在结算页展示，并可供消费者选择：

image.png

对接流程​
商家安装激活流程​
该流程涉及到插件的授权回调流程，此处将结合该流程统一描述 名词解释：

名词	归属	用途
应用地址	该地址逻辑由支付应用提供方维护，需要在创建支付应用时填写该地址；	通常需要在该地址的逻辑中，判断店铺是否有安装该应用，如未授权安装，需要引导商家安装应用；通常会有两种途径直接访问该地址：
1.商家点击安装支付应用时，将会重定向到的地址；

2.商家在支付绑定详情页点击关联账号时，将会打开该地址；
申请授权地址	该地址逻辑由 SHOPLINE 平台维护，需要按一定规则拼接 Url；	您通常需要将授权成功后的重定向地址通过 Query 参数进行传递，具体文档以插件的授权回调流程为准；
应用回调地址	该地址逻辑由支付应用提供方维护，需要在创建支付应用时填写该地址；	用户授权安装插件后， SHOPLINE 将会将用户重定向到该地址；
收款账号绑定地址	该地址逻辑由支付应用提供方维护；	该地址用来将 SHOPLINE 店铺与支付收款账号进行绑定，在以下两种场景，你最终总是要把商家引导到该页面：
1.商家首次安装支付应用时，授权完成之后，初次绑定支付收款账号；

2.商家完成绑定后，通过绑定详情页的管理账号按钮，修改他的支付收款账号信息；
支付配置详情地址	该地址逻辑由 SHOPLINE 平台维护，需要按一定规则拼接Url；	商家在收款账号绑定地址完成绑定操作后，支付应用需要将当前页面重定向回 SHOPLINE 的支付配置详情页，以完成最终的激活操作；
Url拼接规则：https://{handle}.myshopline.com/admin/settings/payments/appInstall?appKey=xxxxx
由于该场景比较复杂，我们将给出一个建议的最佳实践，你可以参考该流程来完成您的授权&安装流程；

红色：该节点依赖商家操作； 绿色：该节点逻辑/页面由支付应用系统实现； 蓝色：该节点页面由SHOPLINE平台实现；

Untitled Diagram (3).png

商家卸载支付应用​
商家不再使用支付应用时，可以在支付配置详情页卸载该应用；此时 SHOPLINE 开放平台将广播应用卸载事件，支付应用方应该要关注该事件，并维护好商家数据；确保商家再次启用时，能正确的再次进入支付应用的授权流程。

支付应用的审核与发布​
你的支付应用需要先在开放平台审核通过，然后商家才能将其安装使用它。

支付应用的灰度控制​
开发者开发应用审核通过之后，默认所有商家都是不允许看到该应用，此时需要联系 SHOPLINE 审核人员为该应用分配灰度测试商家，此时只有灰度中的店铺才能看见该应用。 在充分测试完成后，你可以再次联系 SHOPLINE 审核人员全量开放该应用，全量发布后。该支付应用对所有商家可见。

